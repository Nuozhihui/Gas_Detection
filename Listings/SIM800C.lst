C51 COMPILER V9.60.0.0   SIM800C                                                           05/03/2022 23:46:36 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE SIM800C
OBJECT MODULE PLACED IN .\Objects\SIM800C.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE Library\SIM800C\SIM800C.c COMPACT OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Library
                    -\ADC;.\Library\DHT11;.\Library\LCD;.\Library\STEP;.\Library\Show;.\Library\KEY;.\Library\MAX6675;.\Library\SIM800C) DEBU
                    -G OBJECTEXTEND PRINT(.\Listings\SIM800C.lst) TABS(2) OBJECT(.\Objects\SIM800C.obj)

line level    source

   1          #include "SIM800C.h"
   2          #include "uart.h"
   3          
   4          //常量
   5          #define Success 1U
   6          #define Failure 0U
   7          
   8          //定义变量
   9          unsigned long  Time_Cont = 0;       //定时器计数器
  10          
  11          //char phoneNumber[] = "17865677883";   //替换成需要被拨打电话的号码
  12          //char msg[] = "ILoveMCU.taobao.com";   //短信内容  
  13          
  14          //****************************************************
  15          //主函数
  16          //****************************************************
  17          
  18          
  19          void SIM_Iint()
  20          {
  21   1        Uart_Init();  
  22   1        
  23   1        
  24   1        if (sendCommand("AT\r\n", "OK\r\n", 3000, 10) == Success);
  25   1        else errorLog();
  26   1        delay_ms(10);
  27   1      
  28   1        if (sendCommand("AT+CPIN?\r\n", "READY", 1000, 10) == Success);
  29   1        else errorLog();
  30   1        delay_ms(10);
  31   1      
  32   1      
  33   1        if (sendCommand("AT+CMGF=1\r\n", "OK\r\n", 1000, 10) == Success);
  34   1        else errorLog();
  35   1        delay_ms(10);
  36   1      
  37   1        if (sendCommand("AT+CSMP=17,167,0,8\r\n", "OK\r\n", 3000, 10) == Success);
  38   1        else errorLog();
  39   1        delay_ms(10);
  40   1      
  41   1        if (sendCommand("AT+CSCS=\"GSM\"\r\n", "OK\r\n", 1000, 10) == Success);
  42   1        else errorLog();
  43   1        delay_ms(10);
  44   1      }
  45          
  46          
  47          void sendMessage(char *number,char *msg)
  48          {
  49   1        xdata char send_buf[20] = {0};
  50   1        memset(send_buf, 0, 20);    //清空
  51   1        strcpy(send_buf, "AT+CMGS=\"");
  52   1        strcat(send_buf, number);
  53   1        strcat(send_buf, "\"\r\n");
C51 COMPILER V9.60.0.0   SIM800C                                                           05/03/2022 23:46:36 PAGE 2   

  54   1        if (sendCommand(send_buf, ">", 3000, 10) == Success);
  55   1        else errorLog();
  56   1      
  57   1        if (sendCommand(msg, msg, 3000, 10) == Success);
  58   1        else errorLog();
  59   1      
  60   1        memset(send_buf, 0, 40);    //清空
  61   1        send_buf[0] = 0x1a;
  62   1        send_buf[1] = '\0';
  63   1        if (sendCommand(send_buf, "OK\r\n", 10000, 5) == Success);
  64   1        else errorLog();
  65   1      }
  66          
  67          void phone(char *number)
  68          {
  69   1        char send_buf[20] = {0};
  70   1        memset(send_buf, 0, 20);    //清空
  71   1        strcpy(send_buf, "ATD");
  72   1        strcat(send_buf, number);
  73   1        strcat(send_buf, ";\r\n");
  74   1      
  75   1        if (sendCommand(send_buf, "OK\r\n", 10000, 10) == Success);
  76   1        else errorLog();
  77   1      }
  78          
  79          void errorLog()
  80          {
  81   1        while (1)
  82   1        {
  83   2            if (sendCommand("AT\r\n", "OK\r\n", 100, 10) == Success)
  84   2          {
  85   3          soft_reset();
  86   3          }
  87   2          delay_ms(200);
  88   2        }
  89   1      }
  90          
  91          void soft_reset(void)  //制造重启命令
  92          {
  93   1         ((void (code *) (void)) 0x0000) ();
  94   1      }
  95          
  96          unsigned int sendCommand(char *Command, char *Response, unsigned long Timeout, unsigned char Retry)
  97          {
  98   1        unsigned char n;
  99   1        CLR_Buf();
 100   1        for (n = 0; n < Retry; n++)
 101   1        {
 102   2          SendString(Command);    //发送GPRS指令
 103   2      
 104   2          Time_Cont = 0;
 105   2          while (Time_Cont < Timeout)
 106   2          {
 107   3            delay_ms(100);
 108   3            Time_Cont += 100;
 109   3            if (strstr(Rec_Buf, Response) != NULL)
 110   3            {
 111   4              
 112   4              CLR_Buf();
 113   4              return Success;
 114   4            }
 115   3            
C51 COMPILER V9.60.0.0   SIM800C                                                           05/03/2022 23:46:36 PAGE 3   

 116   3          }
 117   2          Time_Cont = 0;
 118   2        }
 119   1        
 120   1        CLR_Buf();
 121   1        return Failure;
 122   1      }
 123          
 124          //****************************************************
 125          //MS延时函数(12M晶振下测试)
 126          //****************************************************
 127          void delay_ms(unsigned int n)
 128          {
 129   1        unsigned int  i,j;
 130   1          for(i=0;i<n;i++)
 131   1            for(j=0;j<123;j++);
 132   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    938    ----
   CONSTANT SIZE    =    140    ----
   XDATA SIZE       =   ----      20
   PDATA SIZE       =      4      41
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
